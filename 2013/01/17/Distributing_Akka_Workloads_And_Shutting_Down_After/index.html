<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Distributing Akka Workloads - And Shutting Down Afterwards</title>
  
  
  <link href="http://blog.evilmonkeylabs.com" rel="alternate" title="Evil Monkey Labs" type="application/atom+xml" />
  <link rel="openid.delegate" href="http://evilmonkeylabs.myopenid.com" />

  <link rel="stylesheet" href="/stylesheets/application.css" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/evilmonkey.css" type="text/css" />
</head>

<body>
<div id="container">
  <div id="logo">
    <img src="/images/logo_small.png" alt="Evil Monkey Logo"/>
  </div>
  <div id="header">
    <h1><span><a href="/">Evil Monkey Labs</a></span></h1>
    <h2>Code and related ramblings.</h2>
  </div>

  <div id="page">
    <div id="content">
      <div class="hentry" id="/2013/01/17/Distributing_Akka_Workloads_And_Shutting_Down_After">
  <h2 class="entry-title">
    <a href="/2013/01/17/Distributing_Akka_Workloads_And_Shutting_Down_After/">Distributing Akka Workloads - And Shutting Down Afterwards</a>
  </h2>
  
  <abbr class="published" title="2013-01-17T00:00:00-08:00">17 Jan 2013</abbr>
  <br class="clear" />
  <div class="entry-content">
    <p>Recently, as part of my role with the Professional Services team at <a href="http://typesafe.com">Typesafe</a>, I have been working on site at a customer who is using a lot of Akka and Play. During this time, I've gotten a chance to solve some interesting problems and answer obscure questions... which for those who like chasing these kinds of puzzles issues (like myself) is a fantastic way to spend the day (<em>and if this kind of thing sounds exciting to you, we're aggressively hiring for <a href="http://blog.typesafe.com/send-akka-consultant-candidates-our-way-and-w">this kind of work</a> ;)</em> )</p>

<p>One item in particular came up recently as we tried to create a cron-style job to do interval data processing – big blocks of input data would be separated into individual instructions for processing, using <a href="http://doc.akka.io/docs/akka/2.0.5/">Akka 2.0.x</a>. The developer I was working with found that, among other things, using only a single actor to process all of their data items was not particularly performant. Further, once we solved this problem we couldn't figure out how to cleanly shut down Akka without interrupting any messages being processed. Fortunately, Akka offers simple answers to both of these problems... if you know where to look.</p>

<!--more-->


<p>By their nature, an Actor has a mailbox queueing all of the instructions sent to it, in order, and processes these messages one by one. In short, an individual actor is sequential, not parallel – performance is linear as we add more messages.</p>

<div class="highlight"><pre><code class="scala"><span class="k">package</span> <span class="nn">net.evilmonkeylabs.demo</span>

<span class="k">import</span> <span class="nn">akka.actor.</span><span class="o">{</span><span class="nc">ActorSystem</span><span class="o">,</span> <span class="nc">Actor</span><span class="o">,</span> <span class="nc">Props</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.event.Logging</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Message</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">SimpleActor</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Message</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Got a valid message: %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span>
    <span class="k">case</span> <span class="n">default</span> <span class="k">=&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;Got a message I don&#39;t understand.&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">SimpleMain</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;SimpleSystem&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">simpleActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simple&quot;</span><span class="o">)</span>

  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka!&quot;</span><span class="o">)</span> <span class="c1">// toss a message into our actor with the &quot;!&quot; send op</span>
<span class="o">}</span>
</code></pre></div>


<p>The obvious answer here is to spin up a <em>pool</em> of identical actors, all sharing the workload. While I seem to recall having to do a lot of custom work back in the early days of Pre-1.0 Akka, this is now <em>tremendously</em> easy to accomplish in Akka 2.0+, by the magic of <a href="http://doc.akka.io/docs/akka/2.0.5/scala/routing.html">Akka Routing</a>.</p>

<p>You may ask, just what is a Router in Akka? In simple terms, a Router is an Actor which proxies (and by its nature, <a href="http://doc.akka.io/docs/akka/2.0.5/scala/fault-tolerance.html">supervises</a>) the mailbox for one or more child actors (Which I'll refer to as 'Routees' where possible), and routes messages to them with custom behavior. Akka provides a number of predefined Routers, and most of these are designed to have many child actors (aka 'routees') and forward a single inbound message to only <em>one</em> of these routees – though there are also several Routers which broadcast to all, including the very useful <a href="http://doc.akka.io/docs/akka/2.0.5/scala/routing.html#ScatterGatherFirstCompletedRouter"><code>ScatterGatherFirstCompletedRouter</code></a> (the use of which I'll cover in a future post).</p>

<p>In our case, what we wanted was several copies of the same actor, working together, but with a given message processed <em>only once</em> – so we aren't worried about Broadcast style routers for now. For this kind of task, there are two built-in router types that I would reach for personally: <a href="http://doc.akka.io/docs/akka/2.0.5/scala/routing.html#RoundRobinRouter"><code>RoundRobinRouter</code></a>, and <a href="http://doc.akka.io/docs/akka/2.0.5/scala/routing.html#SmallestMailboxRouter"><code>SmallestMailboxRouter</code></a>. The astute reader may also note the existence of a <a href="http://doc.akka.io/docs/akka/2.0.5/scala/routing.html#RandomRouter"><code>RandomRouter</code></a> – but my  background makes me somewhat wary of Random distribution of workload due to fear of <a href="http://en.wikipedia.org/wiki/Hot_spot_(computer_science)">hot spotting</a>.</p>

<p>The <code>RoundRobinRouter</code> and <code>SmallestMailboxRouter</code> are well suited for our needs here, so let's look at those. <code>RoundRobinRouter</code> sends the messages one by one through the list of routees – A, B, C, D then A, B, C, D again and so on. By contrasts, the <code>SmallestMailboxRouter</code> routes messages to the routee with the least messages currently in its queue, so that if one is running faster than others for some reason he can do some extra work. While this behavior is admirable for a more complex system, let's keep things simple in our example. We're going to use the <code>RoundRobinRouter</code> for these examples, as it gives us some predictable &amp; well defined behavior to work with. Spinning up a router on top of an actor – and having it automatically spin up duplicates of that actor to route to - is a fairly straightforward process in Akka. We can leave our existing <code>SimpleActor</code> in place, and just change how we set it up.</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.routing.RoundRobinRouter</span>


<span class="k">object</span> <span class="nc">SimpleRoutedMain</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;SimpleSystem&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">simpleRouted</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">].</span><span class="n">withRouter</span><span class="o">(</span>
                        <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="n">nrOfInstances</span> <span class="k">=</span> <span class="mi">10</span><span class="o">)</span>
                     <span class="o">),</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simpleRoutedActor&quot;</span><span class="o">)</span>

  <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">10</span><span class="o">)</span>  <span class="n">simpleRouted</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka #%d!&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div>


<p>Note the addition of a call to the <code>withRouter()</code> method on our <code>Props[ActorName]</code> declaration. Where a normal <code>Props[ActorName]</code> call sets up a single Actor, <code>withRouter()</code> will return us a Router with <code>nrOfInstances</code> child actors.  Here, we've setup a <code>RoundRobinRouter</code> with 10 routees; if we look at the output of running this new <code>SimpleRoutedMain</code>, we'll see our log entries have several different actor IDs in them:</p>

<div class="highlight"><pre><code class="text">[INFO] [01/17/2013 15:32:51.897] [SimpleSystem-akka.actor.default-dispatcher-7] [akka://SimpleSystem/user/simpleRoutedActor/$f] Got a valid message: Hello, Akka #6!
[INFO] [01/17/2013 15:32:51.900] [SimpleSystem-akka.actor.default-dispatcher-8] [akka://SimpleSystem/user/simpleRoutedActor/$e] Got a valid message: Hello, Akka #5!
[INFO] [01/17/2013 15:32:51.900] [SimpleSystem-akka.actor.default-dispatcher-13] [akka://SimpleSystem/user/simpleRoutedActor/$d] Got a valid message: Hello, Akka #4!
</code></pre></div>


<p>With the previous example, we were very specific in our setup code – hardcoding the type of router we want as well as the number of routee actor instances. Hardcoding is rarely a good idea, and as such Akka also offers an easy way to make this externally configurable. We can change our router instantiation to read from the config instead:</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.routing.</span><span class="o">{</span><span class="nc">FromConfig</span><span class="o">,</span> <span class="nc">RoundRobinRouter</span><span class="o">}</span>


<span class="k">object</span> <span class="nc">SimpleFileConfiggedRoutedMain</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;SimpleSystem&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">simpleRouted</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">].</span><span class="n">withRouter</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">()),</span>
                                    <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simpleRoutedActor&quot;</span><span class="o">)</span>

  <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">10</span><span class="o">)</span>  <span class="n">simpleRouted</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka #%d!&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div>


<p>We've replaced our explicit instantiation of a <code>RoundRobinRouter</code> here with a call to <code>FromConfig()</code>, which tells Akka to find a matching configuration entry with the router setup details.  From here, we then just need to add an entry to our Akka configuration, in the <code>deployment</code> block, with the name we gave our Router:</p>

<div class="highlight"><pre><code class="scala"><span class="n">deployment</span> <span class="o">{</span>
    <span class="o">/</span><span class="n">simpleRoutedActor</span> <span class="o">{</span>
        <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span>
        <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="o">}</span> 
<span class="o">}</span>
</code></pre></div>


<p>Now we have an instance of <code>RoundRobinRouter</code>, spinning up and managing 5 identical copies of our <code>SampleProcessingActor</code> – and we can swap out the router type or even raise &amp; lower the number of routees easily from our configuration. From our standpoint as a programmer, the <code>ActorRef</code> we get back from our router initialization is fairly transparent – messages we send to it get routed automatically to a routee, and replies can come back from those actors as well. This behavior is a boon for us, as it means we can begin sending messages to the router without worrying about any special instructions.</p>

<p>Great! We now have a system for distributing our load. If we were feeling particularly adventurous, we could even combine routers with remote actors... but that's a different post, for another day.</p>

<h2>Cleaning Up After Ourselves</h2>

<p>Here's the part where we once again got stuck. Because we were building a cron job that was meant to run every once in awhile, do its work and then shut down, we found ourselves at odds with Akka's behavior. In order to enable it to run as a daemon and run over long periods of time processing messages at potentially unreliable intervals, Akka's <a href="http://doc.akka.io/docs/akka/2.0.5/general/actor-systems.html"><code>ActorSystem</code></a> starts up a pool of threads. This <code>ActorSystem</code> and its threads continue running – even after our <code>main</code> method completes and we expect exit.  For many types of applications this is ideal, as we want to run continuously; for a cron job however, we want to shut down when our work is done.</p>

<p>The first thought you have might be "Well, just throw in a <code>System.exit()</code> call!". Lest we forget, Actors are worked with asynchronously - we are not blocking while we wait for their actions to complete. We can demonstrate that quickly with a  block of code to interact with our Actors. Let's have our Actors print a message when they receive it, but also print as soon as our loop that sends messages <em>to</em> the actors completes.</p>

<div class="highlight"><pre><code class="scala"><span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">100</span><span class="o">)</span>  <span class="n">simpleRouted</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka #%d!&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>

<span class="nc">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;Finished sending messages to Router.&quot;</span><span class="o">)</span>
</code></pre></div>


<p>You might have expected a more sequential behavior out of this code, where everything went in order, such as:</p>

<div class="highlight"><pre><code class="scala"><span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">2</span>
<span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">3</span>
<span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">4</span>
    <span class="o">...</span>
<span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">98</span>
<span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">99</span>
<span class="nc">Got</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">message</span><span class="k">:</span> <span class="kt">Hello</span><span class="o">,</span> <span class="nc">Akka</span> <span class="k">#</span><span class="mi">100</span>
<span class="nc">Finished</span> <span class="n">sending</span> <span class="n">messages</span> <span class="n">to</span> <span class="nc">Router</span><span class="o">.</span>
</code></pre></div>


<p>Unfortunately, things don't work <em>quite</em> this way – the invocation to send a message to an Actor is asynchronous and returns immediately, not waiting for the Actor to process our message. Which means we probably saw our "Finished Sending" notification well before all of "Got a valid message" printouts. Herein lies our problem – if we force a <code>System.exit()</code> as soon as all of our messages are sent, we will shut down before the processing is done (especially if we are doing something involved like a database operation inside the actor).</p>

<p>Similarly, if instead of System.exit, we were force the <code>ActorSystem</code> to shutdown, we would hit a problem. When the <code>ActorSystem</code> is shut off, Akka will not wait for all queued messages to be processed, and instead begins shutting all Actors down as soon as they finish their <em>current</em> message. Despite our progress with routers, this shutdown behavior is less than ideal for our purposes. Thankfully, there <em>is</em> a solution - but first, let's step back and take a quick look at how we shut down a single actor.</p>

<h3>Poisoning Actors (No, not Wallace Shawn)</h3>

<p><img src="/images/princess_bride_poison.jpg"/></p>

<p>In order to facilitate the concept of "Finish what you are doing, and then shut down" with Actors, Akka offers <code>akka.actor.PoisonPill</code>. As a baked in, default behavior, all Akka Actors will automatically handle a <code>PoisonPill</code> message as an instruction to shut down. To use a <code>PoisonPill</code>, we send it to the actor <em>like any other message</em>. Because of this, it will enter the Actor's mailbox and only be processed when it is dequeued.  So if we load 10,000 "Do a task" messages to an Actor and then send a <code>PoisonPill</code>, we can rightly expect our tasks to complete before the Actor shuts down. This behavior is baked into the default receive handler of all Akka Actors:</p>

<div class="highlight"><pre><code class="scala">      <span class="k">case</span> <span class="nc">PoisonPill</span>               <span class="k">⇒</span> <span class="n">self</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</code></pre></div>


<p>Let's take a brief look at what happens when we use this <code>PoisonPill</code> with a single Actor, before taking a look at Routers:</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.actor.PoisonPill</span> 

<span class="k">object</span> <span class="nc">SimplePoisoner</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;SimpleSystem&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">simpleActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simple&quot;</span><span class="o">)</span>

  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka!&quot;</span><span class="o">)</span>
  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">PoisonPill</span>
  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Boy, that was some tasty arsenic!&quot;</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>


<p>If we run this code, we'll note that after the <code>PoisonPill</code> is sent additional messages sent to the actor disappear, as the target Actor has gone away. But what would happen if we tried this with Routers in play?</p>

<p>Unfortunately,  when sent to a Router, <code>PoisonPill</code> behaves quite differently from many users' expectations – as it is treated differently than normal messages to a router. Because of the way that default "Handle a <code>PoisonPill</code>" behavior is baked into all Actors (of which Routers are), Routers <em>do not</em> forward a <code>PoisonPill</code> to their routees, but instead take it as an instruction directed at themselves.</p>

<p>This behavior can be surprising at first, especially because shutting an Actor down <em>also shuts down all of its children</em>, allowing the children only to continue processing their current message. Again, we find behavior contrary to what we might want.</p>

<h3>Broadcasting to Akka Routers</h3>

<p>Still determined to solve our shutdown problem, what we want to try now is ask each Actor that is routed to shut itself down <em>after its entire queue is processed</em>. A nice side effect of this is that when all of a Router's children shut down, the Router shuts itself down too. While the Routers we are currently using only route a message to a single Actor, it is possible to broadcast a message to all routees - using a special case class <code>akka.routing.Broadcast</code>.  When a Router receives a <code>Broadcast</code>, it unwraps the message contained within and forwards that message to <em>every Actor it is routing for</em>.</p>

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.routing.Broadcast</span>

<span class="n">simpleRouter</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">Message</span><span class="o">(</span><span class="s">&quot;I will not buy this record, it is scratched!&quot;</span><span class="o">))</span>
</code></pre></div>


<p>When running this code, we will see every actor in our Router setup repeat the message, "I will not buy this record, it is scratched!". Because the Router does not look at the message being broadcast once unwrapped, his trick works effectively for our task:</p>

<div class="highlight"><pre><code class="scala"><span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">10</span><span class="o">)</span>  <span class="n">simpleRouter</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka #%d!&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
<span class="n">simpleRouter</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">)</span>
<span class="n">simpleRouter</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello? You&#39;re looking a little green around the gills...&quot;</span><span class="o">)</span> <span class="c1">// never gets read</span>
</code></pre></div>


<p>Great! Our Actors are now getting a correct command to shutdown, and allowing the Router above them to shut down gracefully too. We have timed this messaging to allow our full workload to complete before the shutdown, as well.</p>

<p>But... there's one more problem. If we look at our last block of code and run it, you might notice that the program <em>does not shut down</em>. This is because the <code>ActorSystem</code> remains running, and will not automatically shut itself down. We must instruct it to do so, but now we are back to our original problem – timing.</p>

<p>The best way that I have found to handle this problem is to take advantage of Akka's <a href="http://doc.akka.io/docs/akka/2.0.5/scala/actors.html#Lifecycle_Monitoring_aka_DeathWatch">Lifecycle Monitoring</a>, which allows us to create an actor who listens for notices that Actors have terminated. We need merely notify Akka that we'd like to hear about Terminations of a particular actor, and begin listening for those notices.</p>

<p>Since Akka will automatically shut down a Router when all of its routees have terminated, we should (rightly) expect a "Router Terminated" event soon after broadcasting a <code>PoisonPill</code> to our routees.</p>

<p>Here's a rough sketch of an "Overwatch" actor, who asks for Akka to watch two other actors (One our router, the other a simple actor we won't shutdown for), and when it sees the Router terminate, shuts down the <code>ActorSystem</code>:</p>

<div class="highlight"><pre><code class="scala"><span class="k">class</span> <span class="nc">SystemKillingRouterOverwatch</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>

  <span class="c1">// Setup watching of our other two actors</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">preStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="n">watch</span><span class="o">(</span><span class="nc">RoutedPoisonerWithShutdown</span><span class="o">.</span><span class="n">router</span><span class="o">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">watch</span><span class="o">(</span><span class="nc">RoutedPoisonerWithShutdown</span><span class="o">.</span><span class="n">simpleActor</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Terminated</span><span class="o">(</span><span class="n">corpse</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">corpse</span> <span class="o">==</span> <span class="nc">RoutedPoisonerWithShutdown</span><span class="o">.</span><span class="n">router</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="o">(</span><span class="s">&quot;Received termination notification for &#39;&quot;</span> <span class="o">+</span> <span class="n">corpse</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span>
                    <span class="s">&quot;is in our watch list. Terminating ActorSystem.&quot;</span><span class="o">)</span>
        <span class="nc">RoutedPoisonerWithShutdown</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Received termination notification for &#39;&quot;</span> <span class="o">+</span> <span class="n">corpse</span> <span class="o">+</span> <span class="s">&quot;&#39;,&quot;</span> <span class="o">+</span>
                 <span class="s">&quot;which is not in our deathwatch list.&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">corpse</span><span class="o">))</span>
      <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>


<p>During the startup of the Actor (via the <code>preStart()</code> lifecycle method), we grab the references for two other actors and ask for Akka to <code>watch()</code> them. In the case that we see a <code>Terminated</code> message, which will contain an <code>ActorRef</code>, we compare the <code>corpse</code>'s body; if it is the Router, we shutdown the <code>ActorSystem</code>. If not, we can keep on going.</p>

<p>The body of <code>RoutedPoisonerWithShutdown</code> is just a tweak of what we've been building already, including poisoning an extra Actor to test termination, and setting up our overwatch:</p>

<div class="highlight"><pre><code class="scala"><span class="k">object</span> <span class="nc">RoutedPoisonerWithShutdown</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;SimpleSystem&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">].</span><span class="n">withRouter</span><span class="o">(</span><span class="nc">FromConfig</span><span class="o">()),</span>
                              <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simpleRoutedActor&quot;</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">simpleActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SimpleActor</span><span class="o">],</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;simpleActor&quot;</span><span class="o">)</span>
  <span class="c1">// Start him after the others so their refs are available and he can grab &#39;em (lazy code)</span>
  <span class="k">val</span> <span class="n">overwatch</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">SystemKillingRouterOverwatch</span><span class="o">])</span>

  <span class="n">router</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">Message</span><span class="o">(</span><span class="s">&quot;I will not buy this record, it is scratched!&quot;</span><span class="o">))</span>

  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;If there&#39;s any more stock film of women applauding, I&#39;ll clear the court.&quot;</span><span class="o">)</span>

  <span class="n">simpleActor</span> <span class="o">!</span> <span class="nc">PoisonPill</span>

  <span class="k">for</span> <span class="o">(</span><span class="n">n</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">until</span> <span class="mi">10</span><span class="o">)</span>  <span class="n">router</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello, Akka #%d!&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="o">))</span>
  <span class="n">router</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">)</span>
  <span class="n">router</span> <span class="o">!</span> <span class="nc">Message</span><span class="o">(</span><span class="s">&quot;Hello? You&#39;re looking a little green around the gills...&quot;</span><span class="o">)</span> <span class="c1">// never gets read</span>

<span class="o">}</span>
</code></pre></div>


<p>Running this code, we'll see a notification that <code>simpleActor</code> terminated and we didn't care, followed by <code>simpleRoutedActor</code> terminating – to which we respond by shutting down the <code>ActorSystem</code>!</p>

<p>That's it; with a little basic knowledge we can now not only distribute our Akka workloads, but shut the system down cleanly when we are done with it!</p>

<p><em>If you're interested in taking a closer look, I threw up a <a href="http://github.com/bwmcadams/akka-router-shutdown-demo">repository in Github</a> with all of the code from this post</em></p>

  </div>
  <ul class="meta">
    
    
      <li>Tags: <a rel="tag" href="/tags/#scala">scala</a> <a rel="tag" href="/tags/#akka">akka</a> <a rel="tag" href="/tags/#bestpractices">bestpractices</a></li>
    
    <li>Meta:
      <a href="http://blog.evilmonkeylabs.com/2013/01/17/Distributing_Akka_Workloads_And_Shutting_Down_After/#disqus_thread" rel="bookmark">permalink</a>
      <a href="http://blog.evilmonkeylabs.com">atom</a>
    </li>
  </ul>
  <ul class="posts">
    
    <li><span>Previous: 14 Nov 2012</span> &raquo; <a href="/2012/11/14/mongodb-community-call-for-postcards/">MongoDB Community – Call for Postcards</a></li>
    
    
  </ul>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /**
      * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
      */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://evilmonkeyblog.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=evilmonkeyblog">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

    </div>

    <div id="sidebar">
      <!-- sidebar components -->
      <div class="sidebar-node">
          <h3 class='sidebar-title'>Blogroll</h3>
          <div class='static-body'>
            <ul>
              <li><a href="http://blog.typesafe.com/" title="Typesafe Blog">The Typesafe Blog</a></li>
              <li><a href="http://letitcrash.com/" title="Akka Blog">Let It Crash - The Akka Team Blog</a></li>
              <li><a href="http://blog.10gen.com/" title="10gen Blog">The 10Gen Blog on MongoDB and NoSQL</a></li>
              <li><a href="http://snailinaturtleneck.com/blog/" title="Snail In A Turtleneck">Snail In a Turtleneck - Kristina Chodorow (Maintainer of PHP &amp; Perl for MongoDB)</a></li>
            </ul>
         </div>
        <h3 class='sidebar-title'>Projects &amp; Sites I've Worked On</h3>
        <div class='static-body'>
          <ul>
            <li><a href="http://github.com/bwmcadams/" title="GitHub">GitHub Profile</a></li>
            <li><a href="http://typesafe.com" title="Typesafe">Typesafe</a> <div class="sidebar_tiny">My current employer, Typesafe, is responsible for sponsoring and supporting the Scala programming language, as well as the Akka and Play! frameworks for Scala &amp; Java. As part of the Professional Services team I teach classes on Akka, Play and Scala. Additionally, engage in consulting services to assist customers deploying our products.</div></li>
            <li><a href="http://scala-lang.org" title="Scala">The Scala Programming Language</a></li>
            <li><a href="http://akka.io" title="Akka">Akka</a></li>
            <li><a href="http://playframework.org" title="Play!">Play! Framework</a></li>
            <li><a href="http://mongodb.org/" title="MongoDB">MongoDB</a> 
            <div class="sidebar_tiny">I previously worked fulltime on MongoDB at <a href="http://10gen.com">10gen</a>, maintaining JVM tools such as the <a href="http://github.com/mongodb/mongo-java-driver">Java Driver</a>, <a href="http://github.com/mongodb/casbah">Casbah (Scala Driver)</a> and <a href="http://github.com/mongodb/mongo-hadoop">Hadoop Integration</a>.</div> 
            </li>
            <li><a href="http://github.com/bwmcadams/hammersmith" title="Hammersmith">Hammersmith</a> <div class="sidebar_tiny">An open source next generation driver for MongoDB, designed for asynchronous, high performance operation. Work in progress, unafiliated with 10gen.</div></li>
            <li><a href="http://github.com/mongodb/casbah/" title="Casbah">Casbah</a> <div class="sidebar_tiny">An open source Scala driver for MongoDB that I created, and maintained through December 2012.</div></li>
            <li><a href="http://sluggy.com/" title="Sluggy Freelance">Sluggy Freelance</a> <div class="sidebar_tiny">(I wrote &amp; maintain the current code running the site. [Python+Pylons+MongoDB])</div></li>
            <li><a href="http://userfriendly.org/" title="UserFriendly">UserFriendly</a> <div class="sidebar_tiny">(Once upon a time I built the CMS which runs their site. [Perl+mod_perl])</div></li>
            <li><a href="http://bitbucket.org/namlook/mongokit/">MongoKit</a> <div class="sidebar_tiny">(I've contributed Pylons support and a few other useful hacks.)</div></li>
          </ul>
        </div>
       
        <h3 class='sidebar-title'>Presentations</h3>
          <div class='static-body'>
            <ul>
                <li>
                    <a href="http://www.bigdataspain.org/en-2012/conference/the-promise-and-peril-of-abundance-making-big-data-small/brendan-mcadams">Big Data Spain '12 - The Promise &amp; Peril of Big Data's Abundance</a>
                </li>
                <br/>
                <li>
                    <a href="http://vimeo.com/53402471">Reaktor Dev Day '12 - Asynchronous &amp; Nonblocking Scala</a> 
                </li>
                <br/>
                <li>
                    <a href="http://video.javazone.no/talk/49386440">JavaZone '12 - MongoDB and the JVM: Bringing NoSQL and the Java/Scala Platforms Together</a>
                </li>
                <br/>
                <li>
                  <a href="http://marakana.com/s/post/1088/video_evolution_of_casbah_a_mongodb_driver_for_scala">The Evolution of Casbah: A MongoDB Driver for Scala (AKA: WTF Is a Monad?)</a>
                </li>
           </ul>

          </div>
        
        <h3 class='sidebar-title'>Twitter</h3>
          <div class='static-body' id='twitter_block'>
            <div id="twitter_div">
                <script src="http://widgets.twimg.com/j/2/widget.js"></script>
                <script>
                new TWTR.Widget({
                  version: 2,
                  type: 'profile',
                  rpp: 4,
                  interval: 6000,
                  width: 'auto',
                  height: 300,
                  theme: {
                    shell: {
                      background: '#333333',
                      color: '#ffffff'
                    },
                    tweets: {
                      background: '#000000',
                      color: '#ffffff',
                      links: '#4aed05'
                    }
                  },
                  features: {
                    scrollbar: false,
                    loop: false,
                    live: true,
                    hashtags: true,
                    timestamp: true,
                    avatars: true,
                    behavior: 'all'
                  }
                }).render().setUser('rit').start();
                </script>
          </div>
        </div>
        <h3>Syndicate</h3>
        <ul>
            <li><a href="/atom.xml" title="Articles feed">Articles</a></li>
        </ul>

    <br style="clear:both;" />
  </div>
  </div>
  <div id="footer">
    <hr />
    <p><a href="/">Evil Monkey Labs</a></p>
    <ul>
      <li>made with <a href="http://github.com/vilcans/scribbish-jekyll">scribbish-jekyll</a></li>
    </ul>
    <div id="copyright">
      Copyright &copy; 2009-2013 Brendan W. McAdams.<br>
      <span id="disclaimer">
        Views expressed herein are my own. They in no way reflect the views or opinions of my employer (past, current or future), affiliated projects, publisher, or, in many cases, a sane or rational individual.
      </span>
    </div>
  </div>
</div>
<script type="text/javascript">
var disqus_shortname = 'evilmonkeyblog';
(function () {
  var s = document.createElement('script'); s.async = true;
  s.src = 'http://disqus.com/forums/evilmonkeyblog/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

</body>
</html>
