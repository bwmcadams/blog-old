<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: mapreduce | Bytes.Codes]]></title>
  <link href="http://bytes.codes/categories/mapreduce/atom.xml" rel="self"/>
  <link href="http://bytes.codes/"/>
  <updated>2015-08-23T18:35:06-07:00</updated>
  <id>http://bytes.codes/</id>
  <author>
    <name><![CDATA[Brendan McAdams]]></name>
    <email><![CDATA[brendan@bytes.codes]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[MapReduce with MongoDB 1.8 and Java]]></title>
    <link href="http://bytes.codes/2011/02/28/MongoDB-1_8-MR-Java/"/>
    <updated>2011-02-28T00:00:00-08:00</updated>
    <id>http://bytes.codes/2011/02/28/MongoDB-1_8-MR-Java</id>
    <content type="html"><![CDATA[<p>In my <a href="http://bytes.codes/2011/01/27/MongoDB-1_8-MapReduce/">last post</a>, I introduced the 
new MapReduce features introduced in MongoDB 1.8, which is now <a href="http://www.mongodb.org/display/DOCS/1.8+Release+Notes">available as a release candidate</a>.  Most importantly the temporary collection system has gone away, now requiring that you specify an output parameter.  With that required output comes new options for how to create incremental output using the <em>merge</em> and <em>reduce</em> output modes.</p>

<p>As I write this, we are prepping new releases of our <a href="http://www.mongodb.org/display/DOCS/Java+Language+Center">Java Driver</a> (v2.5) and our <a href="http://api.mongodb.org/scala/casbah">Scala Driver, Casbah</a> (v2.1) which are intended to support MongoDB 1.8’s new features including incremental MapReduce.  Since I implemented the APIs for the new MapReduce output in both drivers, I thought I’d demonstrate the application of these new output features to the previous dataset.  This post is focused on the Java API, but a Scala one will likely follow.</p>

<p>As a reminder (or a primer for those who skipped my <a href="http://bytes.codes/2011/01/27/MongoDB-1_8-MapReduce/">last post</a>), I’ve been testing the 1.8 MapReduce using a dataset and MapReduce job originally created to test the <a href="http://github.com/mongodb/mongo-hadoop">MongoDB+Hadoop Plugin</a>.  It consists of daily U.S. Treasury Yield Data for about 20 years; the MapReduce task calculates an annual average for each year in the collection.  You can grab a copy of the entire collection in a handy mongoimport friendly <a href="https://github.com/mongodb/mongo-hadoop/raw/master/examples/treasury_yield/resources/yield_historical_in.json">datadump from the MongoDB+Hadoop repo</a>; here’s a quick snippet of it:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">WEDNESDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.95</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.92</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.03</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.91</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.75</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.77</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.78</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">THURSDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.95</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.94</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.04</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.91</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.77</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.01</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">FRIDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.98</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.99</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.1</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.93</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.74</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.17</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.76</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.07</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8100000000000005</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">16</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">TUESDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.13</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.2</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.1</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.89</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.25</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.92</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.18</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.99</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<!--more-->

<p>The map function I’m using extracts the year from the date, and the 10 year benchmark value:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">m</span><span class="p">()</span> <span class="p">{</span> 
    <span class="nx">key</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="p">)</span> <span class="o">==</span> <span class="err">“</span><span class="nx">number</span><span class="err">”</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">;</span> 
    <span class="nx">emit</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">sum</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bc10Year</span> <span class="p">}</span> <span class="p">)</span> <span class="p">;</span>
<span class="p">}</span></code></pre></div></p>

<p>… while the reduce function aggregates the data by year, creating a set that can be averaged.  Remember that MongoDB reduce tasks have to be able to be called repeatedly, so the output is crafted to match the input: something that becomes even more important when we say, ask MongoDB to re-reduce our output with the old data.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">r</span><span class="p">(</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">values</span> <span class="p">)</span> <span class="p">{</span> 
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sum</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> 
  <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span> 
      <span class="nx">n</span><span class="p">.</span><span class="nx">sum</span> <span class="o">+=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sum</span><span class="p">;</span> 
      <span class="nx">n</span><span class="p">.</span><span class="nx">count</span> <span class="o">+=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">;</span> 
  <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="k">return</span> <span class="nx">n</span><span class="p">;</span> 
<span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>We’ll round it all out out with a quick and dirty finalize function which can calculate the current average.  Note that I’m keeping all the intermediate data around for demonstrating “reduce” mode.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">value</span> <span class="p">){</span>
  <span class="nx">value</span><span class="p">.</span><span class="nx">avg</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">sum</span> <span class="o">/</span> <span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></div></p>

<p>First, we’ll need to stick these functions into some Java strings to pass around for our testing:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">String</span> <span class="n">m</span> <span class="o">=</span> <span class="err">“</span><span class="n">function</span><span class="o">()</span> <span class="o">{</span> <span class="n">key</span> <span class="o">=</span> <span class="n">typeof</span><span class="o">(</span> <span class="k">this</span><span class="o">.</span><span class="na">_id</span> <span class="o">)</span> <span class="o">==</span> <span class="s">&quot;number&quot;</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">_id</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">_id</span><span class="o">.</span><span class="na">getYear</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">;</span><span class="err">”</span> <span class="o">+</span>
                   <span class="err">“</span><span class="n">emit</span><span class="o">(</span> <span class="n">key</span><span class="o">,</span> <span class="o">{</span> <span class="nl">count:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">sum:</span> <span class="k">this</span><span class="o">.</span><span class="na">bc10Year</span> <span class="o">}</span> <span class="o">);</span><span class="err">”</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span>    <span class="n">String</span> <span class="n">r</span> <span class="o">=</span> <span class="s">&quot;function( year, values ) { var n = { count: 0, sum: 0};&quot;</span> <span class="o">+</span>
               <span class="s">&quot; for ( var i = 0; i &amp;lt; values.length; i ++ ) { n.sum += values[i].sum; &quot;</span> <span class="o">+</span> 
               <span class="s">&quot; n.count += values[i].count; } return n; }&quot;</span><span class="o">;</span>

    <span class="n">String</span> <span class="n">f</span> <span class="o">=</span> <span class="s">&quot;function( year, value ) { value.avg = value.sum / value.count; return value; }&quot;</span><span class="o">;</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>The Java API now allows you to pass an optional <strong><a href="http://api.mongodb.org/java/2.5-pre-/com/mongodb/MapReduceCommand.OutputType.html">MapReduceCommand.OutputType</a></strong> value, which controls the type of output received.  If one is not specifed, the output collection is assumed to be <strong>REPLACE</strong> — namely, the standard mode in which the named collection is replaced completely with the output of the MapReduce job.  Looking at <strong>INLINE</strong> as our example, we can call the new method in collection.  Feel free to set the output collection name to <em>null</em> or a throwaway value; it is ignored by the Java driver in Inline output mode.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">MapReduceOutput</span> <span class="n">out</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="na">mapReduce</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">MapReduceCommand</span><span class="o">.</span><span class="na">OutputType</span><span class="o">.</span><span class="na">INLINE</span><span class="o">,</span> <span class="kc">null</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">for</span> <span class="o">(</span> <span class="n">DBObject</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">out</span><span class="o">.</span><span class="na">results</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">obj</span> <span class="o">);</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>Which should output each DBObject in the results to the screen.  The new MapReduceOutput code detects the result set type from MongoDB and provides it in <code>results()</code> as a <code>Iterable&lt;DBObject&gt;</code>—whether the results are <strong>INLINE</strong> or stored in a collection.  Note that I did not specify the <code>finalize</code> function here, as the interface on <strong>DBCollection</strong> doesn’t accept it as a parameter.  Alternately, we could construct a <strong><a href="http://api.mongodb.org/java/2.5-pre-/com/mongodb/MapReduceCommand.html">MapReduceCommand</a></strong> instance, which allows us to set <code>finalize</code>:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">MapReduceCommand</span> <span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MapReduceCommand</span><span class="o">(</span> <span class="n">coll</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> 
                                             <span class="n">MapReduceCommand</span><span class="o">.</span><span class="na">OutputType</span><span class="o">.</span><span class="na">INLINE</span><span class="o">,</span> <span class="kc">null</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">cmd</span><span class="o">.</span><span class="na">setFinalize</span><span class="o">(</span><span class="n">f</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="na">mapReduce</span><span class="o">(</span><span class="n">cmd</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">for</span> <span class="o">(</span> <span class="n">DBObject</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">out</span><span class="o">.</span><span class="na">results</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">obj</span> <span class="o">);</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>Using the <strong>MERGE</strong> and <strong>REDUCE</strong> Output Modes follows much the same pattern.  I’ll leave figuring out <strong>MERGE</strong> as an exercise for the reader (it should be easy if you read my last post) but here’s how we would handle a <strong>REDUCE</strong> on two halves of the same year.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MapReduceCommand</span><span class="o">(</span> <span class="n">coll</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="err">“</span><span class="n">yield_historical</span><span class="o">.</span><span class="na">out</span><span class="err">”</span><span class="o">,</span> 
                            <span class="n">MapReduceCommand</span><span class="o">.</span><span class="na">OutputType</span><span class="o">.</span><span class="na">REDUCE</span><span class="o">,</span> 
                            <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span><span class="err">“</span><span class="n">_id</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span>
                                                        <span class="err">“</span><span class="n">$gte</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span> <span class="o">)</span>
                                                     <span class="o">).</span><span class="na">append</span><span class="o">(</span>
                                                        <span class="err">“</span><span class="n">$lte</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1</span> <span class="o">)</span>
                                                     <span class="o">)</span>
                                            <span class="o">)</span>
                           <span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">cmd</span><span class="o">.</span><span class="na">setFinalize</span><span class="o">(</span><span class="n">f</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/** Ignore output of first half… */</span>
<span class="n">coll</span><span class="o">.</span><span class="na">mapReduce</span><span class="o">(</span><span class="n">cmd</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="cm">/** Reduce in second half */</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MapReduceCommand</span><span class="o">(</span> <span class="n">coll</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="err">“</span><span class="n">yield_historical</span><span class="o">.</span><span class="na">out</span><span class="err">”</span><span class="o">,</span> 
                            <span class="n">MapReduceCommand</span><span class="o">.</span><span class="na">OutputType</span><span class="o">.</span><span class="na">REDUCE</span><span class="o">,</span> 
                            <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span><span class="err">“</span><span class="n">_id</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span>
                                                        <span class="err">“</span><span class="n">$gt</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1</span> <span class="o">)</span>
                                                     <span class="o">).</span><span class="na">append</span><span class="o">(</span>
                                                        <span class="err">“</span><span class="n">$lte</span><span class="err">”</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">11</span><span class="o">,</span> <span class="mi">31</span> <span class="o">)</span>
                                                     <span class="o">)</span>
                                             <span class="o">)</span>
                           <span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">cmd</span><span class="o">.</span><span class="na">setFinalize</span><span class="o">(</span><span class="n">f</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="na">mapReduce</span><span class="o">(</span><span class="n">cmd</span><span class="o">);&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">for</span> <span class="o">(</span> <span class="n">DBObject</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">out</span><span class="o">.</span><span class="na">results</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">obj</span> <span class="o">);</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>That’s it! Go forth, and MapReduce…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Look At MongoDB 1.8's MapReduce Changes]]></title>
    <link href="http://bytes.codes/2011/01/27/MongoDB-1_8-MapReduce/"/>
    <updated>2011-01-27T00:00:00-08:00</updated>
    <id>http://bytes.codes/2011/01/27/MongoDB-1_8-MapReduce</id>
    <content type="html"><![CDATA[<p>MongoDB 1.7.5 shipped yesterday, and is expected to be the last ‘beta’ release of what will become MongoDB 1.8.  As part of the release, I’ve been doing testing of the new MapReduce functionality and thought this a good time to highlight those changes for people.</p>

<p>If you aren’t new to MongoDB MapReduce, the most important thing to note since MongoDB 1.6.x is that temporary collections are gone; it is now <em>required</em> to specify an output.  Previously, if you omitted the <em>out</em> argument MongoDB would create a temporary collection and return its name with the job results; In non-sharded MongoDB setups these temporary collections would go out of scope and be cleaned up when the connection closed.  Unfortunately, for sharded setups it wasn’t possible to safely clean these up––they would remain behind and clutter up the database.  For this and other reasons the temporary collection feature was removed. There is good news though: they’ve been replaced with an even better system for saving the results of MapReduce jobs!</p>

<p>While the <em>out</em> argument is now a required parameter in MapReduce jobs, it has a number of options for controlling what MongoDB does with results.  If you’re running a truly one-off job where you don’t need to keep the results later, MongoDB now supports returning results “inline”.  Be careful here though: your results are being returned in a single document and are subject to the document size limitations of MongoDB (16MB per document in 1.8).  To use inline results, set the value of <em>out</em> to a document <code>{inline: 1}</code>.  The result object will contain an additional key <em>results</em> which contains the MapReduce output; the <em>result</em> field will be omitted.</p>

<p>As with previous versions of MongoDB, you can specify a collection name (as a string) in the <em>out</em> argument.  If the named collection already exists MongoDB will replace it entirely with the MapReduce results. Along with the inline mode, MongoDB 1.8 introduces support for “merge” and “reduce” output modes; instead of replacing the target collection MongoDB can be instructed to reconcile the MapReduce results with the existing data.  To use these modes, set the value of <em>out</em> to a document with a key of either “merge” or “reduce” and a value of the collection to save to.</p>

<p>The difference in “merge” and “reduce” has to do with MongoDB does when it encounters duplicate keys in both the existing collection and the MapReduce results.  In “merge” mode, MongoDB will simply overwrite the existing key with the new one from the MapReduce output.  In “reduce” mode, MongoDB will run the reduce function again with both the new and old data, saving those results to the collection (you remembered to make your reduce function idempotent, right?). <strong>UPDATE</strong>: If you specified a “finalize” function, MongoDB will re-run this after the “reduce” runs.</p>

<p>Now that I’ve thoroughly confused you, lets dig into examples of each of these behaviors.  I’ve been testing the 1.8 MapReduce using a dataset and MapReduce job originally created to test the <a href="http://github.com/mongodb/mongo-hadoop">MongoDB+Hadoop Plugin</a>.  It consists of daily U.S. Treasury Yield Data for about 20 years; the MapReduce task calculates an annual average for each year in the collection.  You can grab a copy of the entire collection in a handy mongoimport friendly <a href="https://github.com/mongodb/mongo-hadoop/raw/master/examples/treasury_yield/resources/yield_historical_in.json">datadump from the MongoDB+Hadoop repo</a>; here’s a quick snippet of it:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">WEDNESDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.95</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.92</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.03</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.91</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.75</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.77</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mi">8</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.78</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">11</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">THURSDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.95</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.94</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.04</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.91</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.77</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.01</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">FRIDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.98</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.99</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.1</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.93</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.74</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.17</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.76</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.07</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8100000000000005</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="err">“</span><span class="mi">1990</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">16</span><span class="nx">T00</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="nx">Z</span><span class="err">”</span><span class="p">),</span> <span class="err">“</span><span class="nx">dayOfWeek</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">TUESDAY</span><span class="err">”</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.13</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc5Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.11</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc10Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.2</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc20Year</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Month</span><span class="err">”</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc2Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.1</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc3Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.89</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc30Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.25</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc1Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.92</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc7Year</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.18</span><span class="p">,</span> <span class="err">“</span><span class="nx">bc6Month</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.99</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<!--more-->

<p>The map function I’m using extracts the year from the date, and the 10 year benchmark value:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">m</span><span class="p">()</span> <span class="p">{</span> 
    <span class="nx">key</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="p">)</span> <span class="o">==</span> <span class="err">“</span><span class="nx">number</span><span class="err">”</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">;</span> 
    <span class="nx">emit</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">sum</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bc10Year</span> <span class="p">}</span> <span class="p">)</span> <span class="p">;</span>
<span class="p">}</span></code></pre></div></p>

<p>While the reduce function aggregates the data by year, creating a set that can be averaged.  Remember that MongoDB reduce tasks have to be able to be called repeatedly, so the output is crafted to match the input: something that becomes even more important when we say, ask MongoDB to re-reduce our output with the old data.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">r</span><span class="p">(</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">values</span> <span class="p">)</span> <span class="p">{</span> 
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sum</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> 
  <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span> 
      <span class="nx">n</span><span class="p">.</span><span class="nx">sum</span> <span class="o">+=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sum</span><span class="p">;</span> 
      <span class="nx">n</span><span class="p">.</span><span class="nx">count</span> <span class="o">+=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">count</span><span class="p">;</span> 
  <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="k">return</span> <span class="nx">n</span><span class="p">;</span> 
<span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>We’ll round it all out out with a quick and dirty finalize function which can calculate the current average.  Note that I’m keeping all the intermediate data around for demonstrating “reduce” mode.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">value</span> <span class="p">){</span>
  <span class="nx">value</span><span class="p">.</span><span class="nx">avg</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">sum</span> <span class="o">/</span> <span class="nx">value</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></code></pre></div></p>

<p>First, a quick look at “inline” mode (I’ll leave plain old name a collection as an exercise to you, my humble reader).</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">(</span>
<span class="err">…</span>   <span class="p">{</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">mapreduce</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="k">in</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">map</span><span class="err">”</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">finalize</span><span class="err">”</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">query</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">$gt</span><span class="err">”</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">verbose</span><span class="err">”</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">,</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">out</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">inline</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="err">…</span>   <span class="p">}</span>
<span class="err">…</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="err">“</span><span class="nx">results</span><span class="err">”</span> <span class="o">:</span> <span class="p">[</span>
		<span class="p">{</span>
			<span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1990</span><span class="p">,</span>
			<span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.552400000000002</span>
		<span class="p">},</span>
        <span class="cm">/* … */</span>
		<span class="p">{</span>
			<span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2010</span><span class="p">,</span>
			<span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="mf">3.3255026455026435</span>
		<span class="p">}</span>
	<span class="p">],</span>
	<span class="err">“</span><span class="nx">timeMillis</span><span class="err">”</span> <span class="o">:</span> <span class="mi">218</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timing</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">mapTime</span><span class="err">”</span> <span class="o">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">168</span><span class="p">),</span>
		<span class="err">“</span><span class="nx">emitLoop</span><span class="err">”</span> <span class="o">:</span> <span class="mi">215</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">total</span><span class="err">”</span> <span class="o">:</span> <span class="mi">218</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">counts</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">input</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2690</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">emit</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2690</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">output</span><span class="err">”</span> <span class="o">:</span> <span class="mi">11</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">ok</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>To demonstrate “merge” and “reduce” mode, I’m going to use queries to break out the data a bit.  Lets look first at “merge”, by first running MapReduce against the first half of the data, and then merge in the second half.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">blockquote</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">(</span>
<span class="err">…</span>   <span class="p">{</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">mapreduce</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="k">in</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">map</span><span class="err">”</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">finalize</span><span class="err">”</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">query</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">$lt</span><span class="err">”</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">verbose</span><span class="err">”</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">,</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">out</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>   <span class="p">}</span>
<span class="err">…</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="err">“</span><span class="nx">result</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="err">”</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timeMillis</span><span class="err">”</span> <span class="o">:</span> <span class="mi">223</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timing</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">mapTime</span><span class="err">”</span> <span class="o">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">166</span><span class="p">),</span>
		<span class="err">“</span><span class="nx">emitLoop</span><span class="err">”</span> <span class="o">:</span> <span class="mi">217</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">total</span><span class="err">”</span> <span class="o">:</span> <span class="mi">223</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">counts</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">input</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2503</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">emit</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2503</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">output</span><span class="err">”</span> <span class="o">:</span> <span class="mi">10</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">ok</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="err">“</span><span class="nx">value</span><span class="p">.</span><span class="nx">avg</span><span class="err">”</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1990</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">8.552400000000002</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1991</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.8623600000000025</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1992</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.008844621513946</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1993</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.866279999999999</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1994</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">7.085180722891565</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1995</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">6.573920000000002</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1996</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">6.443531746031743</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1997</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">6.353959999999992</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1998</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.262879999999994</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1999</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.646135458167332</span> <span class="p">}</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>
</blockquote>

<p>That gives us our first half of the data; we ran that with a normal named collection output.  Lets merge in the second half:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">(</span>
<span class="err">…</span>   <span class="p">{</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">mapreduce</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="k">in</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">map</span><span class="err">”</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">finalize</span><span class="err">”</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">query</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">$gt</span><span class="err">”</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">}</span> <span class="p">},</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">verbose</span><span class="err">”</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">,</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">out</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">merge</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="err">”</span> <span class="p">},</span>
<span class="err">…</span>   <span class="p">}</span>
<span class="err">…</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="err">“</span><span class="nx">result</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="err">”</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timeMillis</span><span class="err">”</span> <span class="o">:</span> <span class="mi">242</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timing</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">mapTime</span><span class="err">”</span> <span class="o">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">173</span><span class="p">),</span>
		<span class="err">“</span><span class="nx">emitLoop</span><span class="err">”</span> <span class="o">:</span> <span class="mi">236</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">total</span><span class="err">”</span> <span class="o">:</span> <span class="mi">242</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">counts</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">input</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2690</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">emit</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2690</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">output</span><span class="err">”</span> <span class="o">:</span> <span class="mi">21</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">ok</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">blockquote</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="err">“</span><span class="nx">_id</span><span class="err">”</span><span class="o">:</span> <span class="p">{</span><span class="nx">$gt</span><span class="o">:</span> <span class="mi">1998</span><span class="p">}},</span> <span class="p">{</span><span class="err">“</span><span class="nx">value</span><span class="p">.</span><span class="nx">avg</span><span class="err">”</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span> 
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1999</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.646135458167332</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">6.030278884462145</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2001</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.020685483870969</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2002</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.61308</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2003</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.013879999999999</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2004</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.271320000000004</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2005</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.288880000000001</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2006</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.7949999999999955</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2007</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">4.634661354581674</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2008</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">3.6642629482071714</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2009</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">3.2641200000000037</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2010</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">3.3255026455026435</span> <span class="p">}</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
<span class="o">&lt;</span><span class="err">/blockquote&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></div></p>

<p>To close out, lets take “reduce” mode for a quick spin.  We’ll select a half of a year for the first part, and then reduce in the second half.</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">(</span>
<span class="err">…</span>   <span class="p">{</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">mapreduce</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="k">in</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">map</span><span class="err">”</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">finalize</span><span class="err">”</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">query</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> 
<span class="err">…</span>         <span class="err">“</span><span class="nx">$gte</span><span class="err">”</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="err">…</span>         <span class="err">“</span><span class="nx">$lte</span><span class="err">”</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
<span class="err">…</span>     <span class="p">}</span> <span class="p">},</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">verbose</span><span class="err">”</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">,</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">out</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>   <span class="p">}</span>
<span class="err">…</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="err">“</span><span class="nx">result</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="err">”</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timeMillis</span><span class="err">”</span> <span class="o">:</span> <span class="mi">21</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timing</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">mapTime</span><span class="err">”</span> <span class="o">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
		<span class="err">“</span><span class="nx">emitLoop</span><span class="err">”</span> <span class="o">:</span> <span class="mi">17</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">total</span><span class="err">”</span> <span class="o">:</span> <span class="mi">21</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">counts</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">input</span><span class="err">”</span> <span class="o">:</span> <span class="mi">105</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">emit</span><span class="err">”</span> <span class="o">:</span> <span class="mi">105</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">output</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">ok</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2001</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">count</span><span class="err">”</span> <span class="o">:</span> <span class="mi">105</span><span class="p">,</span> <span class="err">“</span><span class="nx">sum</span><span class="err">”</span> <span class="o">:</span> <span class="mf">539.5599999999998</span><span class="p">,</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.138666666666665</span> <span class="p">}</span> <span class="p">}</span></code></pre></div></p>

<p>That handles the first half… Let’s grab the second:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">(</span>            <span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
<span class="err">…</span>   <span class="p">{</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">mapreduce</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="k">in</span><span class="err">”</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">map</span><span class="err">”</span><span class="o">:</span> <span class="nx">m</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">finalize</span><span class="err">”</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">query</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> 
<span class="err">…</span>         <span class="err">“</span><span class="nx">$gt</span><span class="err">”</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="err">…</span>         <span class="err">“</span><span class="nx">$lte</span><span class="err">”</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> 
<span class="err">…</span>     <span class="p">}</span> <span class="p">},</span>
<span class="err">…</span>     <span class="err">“</span><span class="nx">verbose</span><span class="err">”</span> <span class="o">:</span> <span class="kc">true</span> <span class="p">,</span> 
<span class="err">…</span>     <span class="err">“</span><span class="nx">out</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">reduce</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="err">”</span> <span class="p">},</span>
<span class="err">…</span>   <span class="p">}</span>
<span class="err">…</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="err">“</span><span class="nx">result</span><span class="err">”</span> <span class="o">:</span> <span class="err">“</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="err">”</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timeMillis</span><span class="err">”</span> <span class="o">:</span> <span class="mi">26</span><span class="p">,</span>
	<span class="err">“</span><span class="nx">timing</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">mapTime</span><span class="err">”</span> <span class="o">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
		<span class="err">“</span><span class="nx">emitLoop</span><span class="err">”</span> <span class="o">:</span> <span class="mi">22</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">total</span><span class="err">”</span> <span class="o">:</span> <span class="mi">26</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">counts</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span>
		<span class="err">“</span><span class="nx">input</span><span class="err">”</span> <span class="o">:</span> <span class="mi">143</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">emit</span><span class="err">”</span> <span class="o">:</span> <span class="mi">143</span><span class="p">,</span>
		<span class="err">“</span><span class="nx">output</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
	<span class="p">},</span>
	<span class="err">“</span><span class="nx">ok</span><span class="err">”</span> <span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="p">.</span><span class="nx">find</span><span class="p">()</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2001</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">count</span><span class="err">”</span> <span class="o">:</span> <span class="mi">248</span><span class="p">,</span> <span class="err">“</span><span class="nx">sum</span><span class="err">”</span> <span class="o">:</span> <span class="mf">1245.1299999999997</span><span class="p">,</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.020685483870967</span> <span class="p">}</span> <span class="p">}</span></code></pre></div></p>

<p>Of course, this does us no good if the results don’t add up.  A quick comparison between the ‘merged’ output and the ‘reduced’ output validates our code:</p>

<p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">reduced</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2001</span><span class="p">})</span>
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2001</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">count</span><span class="err">”</span> <span class="o">:</span> <span class="mi">248</span><span class="p">,</span> <span class="err">“</span><span class="nx">sum</span><span class="err">”</span> <span class="o">:</span> <span class="mf">1245.1299999999997</span><span class="p">,</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.020685483870967</span> <span class="p">}</span> <span class="p">}</span>
<span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">yield_historical</span><span class="p">.</span><span class="nx">merged</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="mi">2001</span><span class="p">})</span> 
<span class="p">{</span> <span class="err">“</span><span class="nx">_id</span><span class="err">”</span> <span class="o">:</span> <span class="mi">2001</span><span class="p">,</span> <span class="err">“</span><span class="nx">value</span><span class="err">”</span> <span class="o">:</span> <span class="p">{</span> <span class="err">“</span><span class="nx">count</span><span class="err">”</span> <span class="o">:</span> <span class="mi">248</span><span class="p">,</span> <span class="err">“</span><span class="nx">sum</span><span class="err">”</span> <span class="o">:</span> <span class="mf">1245.1300000000003</span><span class="p">,</span> <span class="err">“</span><span class="nx">avg</span><span class="err">”</span> <span class="o">:</span> <span class="mf">5.020685483870969</span> <span class="p">}</span> <span class="p">}</span></code></pre></div></p>

<p>There are some minor differences at a decimal level since we are working with floating point numbers here, but the results are the same.</p>

<p>These new MapReduce output parameters are available in MongoDB as of version 1.7.4 (which is part of the unstable/development branch) and will ship with MongoDB 1.8. Leave a comment; I’d love to hear what clever tricks you can pull off with these new options.</p>
]]></content>
  </entry>
  
</feed>
